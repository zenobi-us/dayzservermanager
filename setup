#!/usr/bin/env bash

build_images() {
    docker build -t "dayzserver:base-local" -f ./pkgs/docker/Dockerfile.base .
    docker build -t "dayzserver:manager-local" -f ./apps/manager/Dockerfile .
    docker build -t "dayzserver:server-local" -f ./apps/server/Dockerfile .
}

create_server() {
    local serverid

    export serverid="${1}"
    service="$(yq '.services.server | to_json(0) ' ./docker-compose.server.yml)"
    service="$(yq '.environment.0 = ("SERVER_ID=${serverid}" | envsubst)' <<<"${service}")"

    # write it into services as .services.${serverid}
    yq -i ".services[strenv(serverid)] = ${service}" docker-compose.yml

    unset serverid
}

case "$1" in
image)
    build_manager_image
    ;;
server)
    create_server "${2}"
    ;;
esac
